<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Explorar | Aldeias Seguras Pessoas Seguras</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
  :root{ --green:#3a7d44; --green-2:#2e7d32; --line:#e7e7e7; --blue:#1f78b4; }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;background:#f6f7f6;color:#333}
  header.site{background:#fff;padding:1rem 2rem;display:flex;justify-content:space-between;align-items:center;box-shadow:0 2px 5px rgba(0,0,0,.08);position:sticky;top:0;z-index:5000}
  .logo{display:flex;gap:10px;align-items:center}.logo img{width:35px;height:35px}.logo h1{margin:0;color:var(--green);font-size:1.1rem}
  nav ul{list-style:none;display:flex;gap:1.2rem;margin:0;padding:0} nav a{text-decoration:none;color:var(--green);font-weight:500}
  .hero{background:url('Imagens/Incendio20.jpg') center/cover no-repeat;color:#fff;text-align:center;padding:3rem 1rem;position:relative}
  .hero::after{content:'';position:absolute;inset:0;background:rgba(0,0,0,.45)} .hero h2{position:relative;z-index:1;margin:0;font-size:2rem}
  #map{height:560px;width:80%;margin:1.25rem auto;border:2px solid #ccc;border-radius:10px;background:#fff}
  #map .leaflet-top{top:14px} #map .leaflet-left{left:14px} #map .leaflet-right{right:14px}
  #map .leaflet-control{box-shadow:0 2px 6px rgba(0,0,0,.12)}
  .legend{background:#fff;border:1px solid #ddd;border-radius:12px;padding:.6rem .8rem;box-shadow:0 2px 6px rgba(0,0,0,.1)}
  .legend b{display:block;margin:.1rem 0 .4rem}
  /* texto da fonte por baixo da legenda */
  .legend .src{margin-top:.45rem;padding-top:.35rem;border-top:1px solid #eee;font-size:.85rem;color:#555}
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:16px;background:#ffe9e9;color:#a33;border:1px solid #f5b5b5;border-radius:10px;padding:.5rem .8rem;display:none;z-index:9999}
  .emergency{background:#e1f8e4;padding:.5rem 1rem;width:100%;margin:2rem auto;border-top:2px solid var(--green-2);border-bottom:2px solid var(--green-2);border-radius:8px;display:flex;flex-direction:column;align-items:center}
  .emergency h3{color:#c0392b;font-size:1.2rem;margin:.2rem 0}.emergency p{font-size:.95rem;margin:.2rem 0}
  footer{background:#fff;padding:.5rem;text-align:center;margin-top:auto;font-size:.9rem;color:#555}
  @media (max-width:992px){ #map{width:95%} nav ul{flex-direction:column;align-items:center} .hero h2{font-size:1.6rem} }
</style>
</head>
<body>
<header class="site">
  <div class="logo"><img src="Imagens/Aldeia.png" alt="Logo"><h1>Aldeias Seguras Pessoas Seguras</h1></div>
  <nav>
    <ul>
      <li><a href="index.html">Início</a></li>
      <li><a href="compreender.html">Compreender</a></li>
      <li><a href="explorar.html">Explorar</a></li>
      <li><a href="reduzir.html">Reduzir</a></li>
      <li><a href="aldeias.html">Aldeias Seguras</a></li>
      <li><a href="Incendio.html">Fogo à Vista</a></li>
      <li><a href="contacto.html">Contacto</a></li>
    </ul>
  </nav>
</header>

<section class="hero"><h2>Explorar – Mapas de Caracterização</h2></section>

<div id="map"></div>
<div class="toast" id="toast"></div>

<section class="emergency">
  <h3>⚠️ Em caso de emergência ⚠️</h3>
  <p>Ligue imediatamente <strong>112</strong>.</p>
</section>
<footer>© 2025 Ruben Sousa · Todos os direitos reservados</footer>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/proj4@2.11.0/dist/proj4.js"></script>
<script>
  // ====== FICHEIROS ======
  const PATH_FREG = 'Shapfiles/FreguesiasArcos.json';
  const PATH_OCUP = 'Shapfiles/OcupacaoSolo.json';
  const PATH_ALT  = 'Shapfiles/altitude.json';
  const PATH_ARD  = 'Shapfiles/AreaArdida.json';
  const PATH_SLP  = 'Shapfiles/Declives.json';
  const PATH_PERI = 'Shapfiles/Perigosidade.json';   // NOVO

  // ====== CAMPOS ======
  const KEY_FREG    = 'Freguesia';
  const KEY_OCUP    = 'COS18n1_L';
  const KEY_ALT_TXT = 'classe_alt';
  const KEY_ALT_CD  = 'gridcode';
  const KEY_SLP_TXT = 'declive_cl';
  const KEY_SLP_CD  = 'gridcode';
  const KEY_PERI_CD = 'gridcode';                    // Perigosidade: usa gridcode 0..5

  // ====== CORES ======
  const OCUP_COLORS = {
    "Territórios artificializados": "#ff0000",
    "Agricultura": "#ffff00",
    "Pastagens": "#ff7f00",
    "Florestas": "#006400",
    "Matos": "#7fff00",
    "Espaços descobertos ou com pouca vegetação": "#d9d9d9",
    "Massas de água superficiais": "#0000ff"
  };

  const ALT_LABELS = ["<250","250 - 500","500 - 750","750 - 1000",">1000"];
  const ALT_COLORS = {
    "<250":       "#006400",
    "250 - 500":  "#4daf4a",
    "500 - 750":  "#ffff66",
    "750 - 1000": "#ff9900",
    ">1000":      "#e31a1c"
  };
  const ALT_CODE_TO_LABEL = {1:"<250",2:"250 - 500",3:"500 - 750",4:"750 - 1000",5:">1000"};

  const SLP_LABELS = ['<3','3,1 - 8','8,1 - 15','15,1 - 25','25,1 - 35','>35'];
  const SLP_COLORS = {
    '<3':        '#006400',
    '3,1 - 8':   '#2E7D32',
    '8,1 - 15':  '#7FFF00',
    '15,1 - 25': '#FFD700',
    '25,1 - 35': '#FFA500',
    '>35':       '#FF0000'
  };
  const SLP_CODE_TO_LABEL = {1:'<3',2:'3,1 - 8',3:'8,1 - 15',4:'15,1 - 25',5:'25,1 - 35',6:'>35'};

  // Perigosidade: cores por gridcode 0..5 (0 = Nula)
  const PERI_COLORS = {
    0: '#FFFFFF', // Nula
    1: '#2E7D32', // Muito Baixo
    2: '#FFFF00', // Baixo
    3: '#FFA500', // Médio
    4: '#FF0000', // Alto
    5: '#8B0000'  // Muito Alto
  };
  const PERI_CLASS_NAME = {
    0: 'Nula',
    1: 'Muito Baixo',
    2: 'Baixo',
    3: 'Médio',
    4: 'Alto',
    5: 'Muito Alto'
  };

  // ====== HELPERS ======
  const toast = (msg)=>{ const t=document.getElementById('toast'); t.textContent=msg; t.style.display='block'; clearTimeout(t._to); t._to=setTimeout(()=>t.style.display='none',4000); };
  function popupAll(p){ let h=''; for (const k in p) h += `<b>${k}</b>: ${p[k]}<br>`; return h||'Sem atributos'; }

  // Normalizador de rótulos do declive
  function normalizeSlpLabel(lbl){
    if (!lbl) return null;
    const s = String(lbl).trim();
    const map = {
      '<3%':'<3','<3':'<3',
      '3.1–8%':'3,1 - 8','3.1 - 8':'3,1 - 8','3,1–8':'3,1 - 8',
      '8.1–15%':'8,1 - 15','8.1 - 15':'8,1 - 15',
      '15.1–25%':'15,1 - 25','15.1 - 25':'15,1 - 25',
      '25.1–35%':'25,1 - 35','25.1 - 35':'25,1 - 35',
      '>35%':'>35','> 35':'>35'
    };
    return map[s] || s;
  }

  // reprojeção automática se algum GeoJSON vier em EPSG:3763
  proj4.defs('EPSG:3763','+proj=tmerc +lat_0=39.66825833333333 +lon_0=-8.13310833333333 +k=1 +x_0=0 +y_0=0 +ellps=GRS80 +units=m +no_defs');
  function looksProjected(gj){
    let c=null;
    (function pick(g){
      if (!g) return;
      if (g.type==='Point') c=g.coordinates;
      else if (g.type==='MultiPoint'||g.type==='LineString') c=g.coordinates?.[0];
      else if (g.type==='MultiLineString'||g.type==='Polygon') c=g.coordinates?.[0]?.[0];
      else if (g.type==='MultiPolygon') c=g.coordinates?.[0]?.[0]?.[0];
      else if (g.type==='GeometryCollection') return pick(g.geometries?.[0]);
    })(gj.type==='Feature'?gj.geometry:(gj.features?.[0]?.geometry||gj));
    return Array.isArray(c) && Math.abs(c[0])>180;
  }
  function reprojectGeoJSON(gj, from='EPSG:3763', to='EPSG:4326'){
    const projPt = (coord)=>{ const p=proj4(from,to,coord); coord[0]=p[0]; coord[1]=p[1]; };
    const walk=(arr,d)=>{ if(!arr)return; if(d===1){for(const c of arr) projPt(c);} else {for(const a of arr) walk(a,d-1);} };
    const handle=(geom)=>{ if(!geom)return;
      switch(geom.type){
        case 'Point': projPt(geom.coordinates); break;
        case 'MultiPoint':
        case 'LineString': walk(geom.coordinates,1); break;
        case 'MultiLineString':
        case 'Polygon': walk(geom.coordinates,2); break;
        case 'MultiPolygon': walk(geom.coordinates,3); break;
        case 'GeometryCollection': geom.geometries.forEach(handle); break;
      }
    };
    if (gj.type==='FeatureCollection') gj.features.forEach(f=>handle(f.geometry));
    else if (gj.type==='Feature') handle(gj.geometry); else handle(gj);
    if (gj.crs) delete gj.crs;
    return gj;
  }
  async function loadFix(url){
    const r = await fetch(url,{cache:'no-cache'});
    if (!r.ok) throw new Error(`Erro ${r.status} em ${url}`);
    const gj = await r.json();
    if (looksProjected(gj)) reprojectGeoJSON(gj,'EPSG:3763','EPSG:4326');
    return gj;
  }

  // ====== MAPA ======
  const map = L.map('map').setView([41.9, -8.4], 10);
  const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19, attribution: '© OpenStreetMap'
  }).addTo(map);

  // ====== CAMADAS ======
  let layerFreg, layerOcup, layerAlt, layerArd, layerSlp, layerPeri;

  // Freguesias
  const pFreg = loadFix(PATH_FREG).then(gj=>{
    layerFreg = L.geoJSON(gj, {
      style:{ color:'#1f78b4', weight:2, fillOpacity:0.1 },
      onEachFeature:(f,l)=>{
        const nome = f.properties?.[KEY_FREG];
        l.bindPopup((nome?`<b>Freguesia</b>: ${nome}`:'<b>Freguesia</b>')+'<hr>'+popupAll(f.properties));
      }
    }).addTo(map);
  });

  // Ocupação do Solo
  const pOcup = loadFix(PATH_OCUP).then(gj=>{
    layerOcup = L.geoJSON(gj, {
      style:(feat)=>{
        const cat = String(feat.properties?.[KEY_OCUP] ?? 'Sem classe');
        const clr = OCUP_COLORS[cat] || '#cccccc';
        return { stroke:false, fillColor: clr, fillOpacity: 0.65 };
      },
      onEachFeature:(f,l)=>{
        const cat = f.properties?.[KEY_OCUP] ?? 'Sem classe';
        l.bindPopup(`<b>Classe</b>: ${cat}<hr>` + popupAll(f.properties));
      }
    });
  });

  // Altitude
  const pAlt = loadFix(PATH_ALT).then(gj=>{
    layerAlt = L.geoJSON(gj, {
      style:(feat)=>{
        let label = feat.properties?.[KEY_ALT_TXT];
        if (!label && feat.properties?.[KEY_ALT_CD]!=null) label = ALT_CODE_TO_LABEL[Number(feat.properties[KEY_ALT_CD])];
        const clr = ALT_COLORS[label] || '#cccccc';
        return { stroke:false, fillColor: clr, fillOpacity:0.7 };
      },
      onEachFeature:(f,l)=>{
        let label = f.properties?.[KEY_ALT_TXT];
        if (!label && f.properties?.[KEY_ALT_CD]!=null) label = ALT_CODE_TO_LABEL[Number(f.properties[KEY_ALT_CD])];
        l.bindPopup(`<b>Altitude</b>: ${label || 'Sem classe'}`);
      }
    });
  });

  // Área Ardida
  const pArd = loadFix(PATH_ARD).then(gj=>{
    layerArd = L.geoJSON(gj, {
      style:{ stroke:false, fillColor:'#ff0000', fillOpacity:0.6 },
      onEachFeature:(f,l)=>{ l.bindPopup('<b>Área Ardida</b><hr>' + popupAll(f.properties)); }
    });
  });

  // Declive
  const pSlp = loadFix(PATH_SLP).then(gj=>{
    layerSlp = L.geoJSON(gj, {
      style:(feat)=>{
        let label = normalizeSlpLabel(feat.properties?.[KEY_SLP_TXT]);
        if (!label && feat.properties?.[KEY_SLP_CD]!=null) label = SLP_CODE_TO_LABEL[Number(feat.properties[KEY_SLP_CD])];
        const clr = SLP_COLORS[label] || '#cccccc';
        return { stroke:false, fillColor: clr, fillOpacity: 0.6 };
      },
      onEachFeature:(f,l)=>{
        let label = normalizeSlpLabel(f.properties?.[KEY_SLP_TXT]);
        if (!label && f.properties?.[KEY_SLP_CD]!=null) label = SLP_CODE_TO_LABEL[Number(f.properties[KEY_SLP_CD])];
        l.bindPopup(`<b>Declive</b>: ${label || 'Sem classe'}<hr>` + popupAll(f.properties));
      }
    });
  });

  // Perigosidade (gridcode 0..5)
  const pPeri = loadFix(PATH_PERI).then(gj=>{
    layerPeri = L.geoJSON(gj, {
      style:(feat)=>{
        const code = Number(feat.properties?.[KEY_PERI_CD]);
        const clr  = PERI_COLORS.hasOwnProperty(code) ? PERI_COLORS[code] : PERI_COLORS[0]; // 0/Nula p/ ausentes
        return { stroke:false, fillColor: clr, fillOpacity: (code===0||isNaN(code)) ? 0.85 : 0.55 };
      },
      onEachFeature:(f,l)=>{
        const code = Number(f.properties?.[KEY_PERI_CD]);
        const nome = PERI_CLASS_NAME.hasOwnProperty(code) ? PERI_CLASS_NAME[code] : PERI_CLASS_NAME[0];
        l.bindPopup(`<b>Perigosidade</b>: ${nome} ${isNaN(code)?'':'('+code+')'}<hr>` + popupAll(f.properties));
      }
    });
  });

  // Quando tudo carregar
  Promise.all([pFreg,pOcup,pAlt,pArd,pSlp,pPeri]).then(()=>{
    const overlays = {
      'Freguesias (Arcos de Valdevez)': layerFreg,
      'Ocupação do Solo': layerOcup,
      'Altitude (classes)': layerAlt,
      'Área Ardida (1975–2024)': layerArd,
      'Declive (classes)': layerSlp,
      'Perigosidade 2020-2030': layerPeri
    };

    // sem baseLayers no controlo (OSM mantém-se visível)
    L.control.layers(null, overlays, { collapsed:false }).addTo(map);

    if (layerFreg) layerFreg.addTo(map);

    // Legendas + fonte
    const legendOcup = L.control({ position:'bottomright' });
    legendOcup.onAdd = function(){
      const div = L.DomUtil.create('div','legend'); div.innerHTML = '<b>Ocupação do solo</b>';
      Object.entries(OCUP_COLORS).forEach(([lbl,clr])=>{
        div.innerHTML += `<div style="display:flex;align-items:center;gap:6px;margin:3px 0;">
          <span style="width:18px;height:12px;background:${clr};display:inline-block;border:1px solid #555;border-radius:2px;"></span>${lbl}
        </div>`;
      });
      div.innerHTML += `<div class="src">Fonte: Dados provenientes da COS2018</div>`;
      return div;
    };

    const legendAlt = L.control({ position:'bottomright' });
    legendAlt.onAdd = function(){
      const div = L.DomUtil.create('div','legend'); div.innerHTML = '<b>Altitude (m)</b>';
      ALT_LABELS.forEach(lbl=>{
        div.innerHTML += `<div style="display:flex;align-items:center;gap:6px;margin:3px 0;">
          <span style="width:18px;height:12px;background:${ALT_COLORS[lbl]};display:inline-block;border:1px solid #555;border-radius:2px;"></span>${lbl}
        </div>`;
      });
      div.innerHTML += `<div class="src">Fonte: Dados provenientes do CIGeoE</div>`;
      return div;
    };

    const legendArd = L.control({ position:'bottomright' });
    legendArd.onAdd = function(){
      const div = L.DomUtil.create('div','legend'); 
      div.innerHTML = '<b>Área ardida (1975–2024)</b>';
      div.innerHTML += `<div style="display:flex;align-items:center;gap:6px;margin:3px 0;">
        <span style="width:18px;height:12px;background:#ff0000;display:inline-block;border:1px solid #555;border-radius:2px;"></span> Área ardida
      </div>`;
      div.innerHTML += `<div class="src">Fonte: Dados provenientes do ICNF</div>`;
      return div;
    };

    const legendSlp = L.control({ position:'bottomright' });
    legendSlp.onAdd = function(){
      const div = L.DomUtil.create('div','legend'); div.innerHTML = '<b>Declive (%)</b>';
      SLP_LABELS.forEach(lbl=>{
        div.innerHTML += `<div style="display:flex;align-items:center;gap:6px;margin:3px 0;">
          <span style="width:18px;height:12px;background:${SLP_COLORS[lbl]};display:inline-block;border:1px solid #555;border-radius:2px;"></span>${lbl}
        </div>`;
      });
      div.innerHTML += `<div class="src">Fonte: Dados provenientes do CIGeoE</div>`;
      return div;
    };

    const legendPeri = L.control({ position:'bottomright' });
    legendPeri.onAdd = function(){
      const div = L.DomUtil.create('div','legend'); 
      div.innerHTML = '<b>Classe de Perigosidade</b>';
      [0,1,2,3,4,5].forEach(code=>{
        const clr = PERI_COLORS[code], nome = PERI_CLASS_NAME[code];
        div.innerHTML += `<div style="display:flex;align-items:center;gap:6px;margin:3px 0;">
          <span style="width:18px;height:12px;background:${clr};display:inline-block;border:1px solid #555;border-radius:2px;"></span>${nome}
        </div>`;
      });
      div.innerHTML += `<div class="src">Fonte: Dados provenientes do ICNF</div>`;
      return div;
    };

    function refreshLegends(){
      if (map.hasLayer(layerOcup)) legendOcup.addTo(map); else legendOcup.remove();
      if (map.hasLayer(layerAlt))  legendAlt.addTo(map);  else legendAlt.remove();
      if (map.hasLayer(layerArd))  legendArd.addTo(map);  else legendArd.remove();
      if (map.hasLayer(layerSlp))  legendSlp.addTo(map);  else legendSlp.remove();
      if (map.hasLayer(layerPeri)) legendPeri.addTo(map); else legendPeri.remove();
    }
    map.on('overlayadd overlayremove', refreshLegends);
    refreshLegends();

    if (layerFreg) { try { map.fitBounds(layerFreg.getBounds(), {padding:[20,20]}); } catch {} }
    L.control.scale({ metric:true, imperial:false }).addTo(map);
  }).catch(err=>{
    console.error(err);
    toast('Erro a carregar camadas: ' + (err.message||err));
  });
</script>
</body>
</html>

