<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Registar — Aldeias Seguras Pessoas Seguras</title>
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,500,700&display=swap" rel="stylesheet" />
  <style>
    :root{
      --green:#2e7d32; --green-2:#256b2a; --line:#e7e7e7;
      --shadow:0 8px 24px rgba(0,0,0,.10);
      --bg-grad: radial-gradient(1100px 500px at 10% -10%, #eaf7ee 0%, transparent 60%),
                 radial-gradient(1000px 500px at 110% 0%, #eef5ff 0%, transparent 55%),
                 linear-gradient(#fafafa, #f5f7f6);
      --text:#222; --muted:#4b5b4f;
    }
    @media (prefers-color-scheme: dark){
      :root{ --bg-grad: linear-gradient(180deg,#0f1512,#0b120e);
             --text:#e8f1eb; --muted:#a8b6ad; --line:#1f2a24;
             --shadow:0 8px 24px rgba(0,0,0,.45); }
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:'Roboto',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text); line-height:1.6;
      min-height:100dvh;
      display:flex; align-items:center; justify-content:center;
      background:var(--bg-grad);
      padding:max(12px, env(safe-area-inset-top)) max(12px, env(safe-area-inset-right))
              max(12px, env(safe-area-inset-bottom)) max(12px, env(safe-area-inset-left));
    }

    a{ color:var(--green); text-decoration:none }
    a:hover{ text-decoration:underline }

    /* Cartão */
    .auth-card{
      width:min(100%, 440px);
      background:#fff; border:1px solid var(--line);
      border-radius:16px; box-shadow:var(--shadow);
      overflow:hidden; display:flex; flex-direction:column;
      max-height:calc(100dvh - max(24px, env(safe-area-inset-top) + env(safe-area-inset-bottom)));
    }
    @media (prefers-color-scheme: dark){ .auth-card{ background:#0f1713 } }

    .auth-head{
      padding:.7rem .7rem; display:flex; align-items:center; gap:.6rem;
      border-bottom:1px solid var(--line); background:#f9fbf9; flex:0 0 auto;
    }
    @media (prefers-color-scheme: dark){ .auth-head{ background:#0c140f } }

    /* Voltar DENTRO do header (mobile) */
    .back-link-inline{
      display:inline-flex; align-items:center; gap:.4rem;
      font-weight:700; padding:.5rem .7rem;
      background:#eef7ef; border:1px solid #d5ead7; color:var(--green-2);
      border-radius:999px; text-wrap:nowrap; box-shadow:var(--shadow);
      flex:0 0 auto;
    }
    .back-link-inline:hover{ text-decoration:none; filter:brightness(1.02) }
    @media (prefers-color-scheme: dark){
      .back-link-inline{ background:#122018; border-color:#1e3b2e; color:#a9e0b6 }
    }

    /* Voltar FIXO (desktop) */
    .back-link-fixed{
      position:fixed; z-index:5; display:none;   /* escondido por defeito (mobile) */
      top:24px; left:24px;                        /* como tinhas no desktop */
      font-weight:700; padding:.5rem .7rem;
      background:#eef7ef; border:1px solid #d5ead7; color:var(--green-2);
      border-radius:999px; text-wrap:nowrap; box-shadow:var(--shadow);
    }
    .back-link-fixed:hover{ text-decoration:none; filter:brightness(1.02) }
    @media (prefers-color-scheme: dark){
      .back-link-fixed{ background:#122018; border-color:#1e3b2e; color:#a9e0b6 }
    }

    /* A partir de 900px: mostra o fixo e esconde o inline */
    @media (min-width:900px){
      .back-link-fixed{ display:inline-flex }
      .back-link-inline{ display:none }
    }

    .brand{ display:flex; align-items:center; gap:.6rem; min-width:0 }
    .brand img{ width:34px; height:34px; flex:0 0 auto }
    .brand h1{ margin:0; font-size:clamp(.95rem, 2.2vw, 1.05rem); color:var(--green); font-weight:700;
               white-space:nowrap; overflow:hidden; text-overflow:ellipsis }

    .auth-body{
      padding:1rem 1rem .9rem; flex:1 1 auto;
      overflow:auto; -webkit-overflow-scrolling:touch; scroll-padding-bottom:96px;
    }

    .title{ margin:.1rem 0 .2rem; font-size:clamp(1.25rem, 5vw, 1.5rem); font-weight:700; color:#1b5e20 }
    .subtitle{ margin:0 0 .8rem; color:var(--muted); font-size:clamp(.95rem, 3.5vw, 1rem) }

    label{ display:block; font-weight:600; color:#1f3b22; margin:.25rem 0 .25rem }
    @media (prefers-color-scheme: dark){ label{ color:#cfe4d5 } }

    .row{ display:grid; grid-template-columns:1fr; gap:.85rem }

    .input-wrap{ position:relative }
    input{
      width:100%; padding:.9rem .95rem;
      border:1px solid #cfd9cf; border-radius:12px; outline:none; background:#fff;
      font:16px/1.2 inherit; min-height:44px;
      box-shadow: inset 0 1px 2px rgba(0,0,0,.02);
      transition: box-shadow .15s ease, border-color .15s ease;
    }
    @media (prefers-color-scheme: dark){ input{ background:#0f1512; border-color:#2a3a32; color:#e8f1eb } }
    input:focus{
      border-color:#9acd9e;
      box-shadow:0 0 0 3px color-mix(in srgb, #3a7d44 20%, transparent), inset 0 1px 2px rgba(0,0,0,.02);
    }

    .toggle-pass{
      position:absolute; right:.45rem; top:50%; transform:translateY(-50%);
      border:0; background:#eef7ef; color:var(--green-2);
      padding:.5rem .7rem; border-radius:10px; cursor:pointer;
      border:1px solid #d5ead7; font-weight:700; line-height:1;
      min-width:44px; min-height:36px;
    }
    @media (prefers-color-scheme: dark){
      .toggle-pass{ background:#122018; border-color:#1e3b2e; color:#a9e0b6 }
    }

    .meter{margin:.35rem 0 .1rem; height:8px; background:#f0f2f0; border-radius:999px; overflow:hidden; border:1px solid #e6ece6}
    .meter > span{display:block; height:100%; width:0; transition:width .25s ease; background:linear-gradient(90deg,#ff6b6b,#ffd166,#9be15d)}

    .terms{ display:flex; align-items:flex-start; gap:.55rem; margin-top:.4rem; font-size:.98rem }
    .terms input{ inline-size:1.05rem; block-size:1.05rem; margin-top:.25rem }

    .btn{
      display:inline-block; width:100%;
      padding:1rem 1rem; border:0; border-radius:12px; font-weight:800; cursor:pointer;
      background:linear-gradient(180deg,#2e7d32,#256b2a); color:#fff; box-shadow:0 3px 10px rgba(46,125,50,.25);
      margin-top:.7rem; min-height:48px;
    }
    .btn:hover{ filter:brightness(1.03) }
    .btn:active{ transform: translateY(1px) }

    .muted{ text-align:center; font-size:.98rem; color:#566; margin:.7rem 0 0 }
    @media (prefers-color-scheme: dark){ .muted{ color:#90a49a } }

    @media (max-width:520px){
      .auth-head{ padding:.6rem .6rem }
      .auth-body{ padding:.9rem .9rem .8rem }
      .brand h1{ max-width:52vw }
    }

    @media (min-width:720px){
      body{ padding:24px }
      .auth-card{ width:min(100%, 520px) }
    }

    @media (prefers-reduced-motion: reduce){
      *{ animation:none!important; transition:none!important }
    }
  </style>
</head>
<!-- Variáveis do Supabase -->
<script>
  window.SUPABASE_URL  = "https://pyxoudeamrfisegykdtg.supabase.co";
  window.SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB5eG91ZGVhbXJmaXNlZ3lrZHRnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc2MjUzMzQsImV4cCI6MjA3MzIwMTMzNH0.CBOB_ynuUGkrzCdz3bT5YkZvtERRBpV4GJ2AmbHEQdE";
</script>
<body>

  <!-- Voltar FIXO (visível só no desktop) -->
  <a href="index.html" class="back-link-fixed">← Voltar</a>

  <main class="auth-card" role="main">
    <div class="auth-head">
      <!-- Voltar INLINE (visível só no mobile/tablet) -->
      <a href="index.html" class="back-link-inline">← Voltar</a>

      <div class="brand">
        <img src="Imagens/Aldeia.png" alt="Logótipo" loading="lazy" decoding="async">
        <h1>Aldeias Seguras Pessoas Seguras</h1>
      </div>
    </div>

    <div class="auth-body">
      <h2 class="title">Criar conta</h2>
      <p class="subtitle">Regista-te para aceder à tua área.</p>

      <form id="registerForm" novalidate>
        <div class="row">
          <div>
            <label for="nome">Nome</label>
            <input id="nome" name="nome" type="text" autocomplete="name" required />
            <div id="nomeErr" class="error" role="status" aria-live="polite"></div>
          </div>
          <div>
            <label for="email">E-mail</label>
            <input id="email" name="email" type="email" inputmode="email" autocomplete="email" required />
            <div id="emailErr" class="error" role="status" aria-live="polite"></div>
          </div>
        </div>

        <div class="row" style="margin-top: .85rem;">
          <div>
            <label for="morada">Morada (opcional)</label>
            <input id="morada" name="morada" type="text" autocomplete="street-address" placeholder="A sua rua e número de porta" />
          </div>
        </div>

        <div class="row" style="grid-template-columns: 1fr 1fr; gap: .85rem; margin-top: .85rem;">
          <div>
            <label for="codigo_postal">Código Postal (opcional)</label>
            <input id="codigo_postal" name="codigo_postal" type="text" autocomplete="postal-code" placeholder="Ex: 4970-000" />
          </div>
          <div>
            <label for="localidade">Localidade (opcional)</label>
            <input id="localidade" name="localidade" type="text" autocomplete="address-level2" placeholder="Ex: Arcos de Valdevez" />
          </div>
        </div>

        <div class="row">
          <div>
            <label for="password">Palavra-passe</label>
            <div class="input-wrap">
              <input id="password" name="password" type="password" autocomplete="new-password" required minlength="8" />
              <button type="button" class="toggle-pass" data-target="password" aria-controls="password" aria-pressed="false" aria-label="Mostrar palavra-passe">Mostrar</button>
            </div>
            <div class="meter" aria-hidden="true"><span id="meterFill"></span></div>
            <div id="passErr" class="error" role="status" aria-live="polite"></div>
          </div>
          <div>
            <label for="confirm">Confirmar palavra-passe</label>
            <div class="input-wrap">
              <input id="confirm" name="confirm" type="password" autocomplete="new-password" required />
              <button type="button" class="toggle-pass" data-target="confirm" aria-controls="confirm" aria-pressed="false" aria-label="Mostrar confirmação">Mostrar</button>
            </div>
            <div id="confirmErr" class="error" role="status" aria-live="polite"></div>
          </div>
        </div>

        <label class="terms">
          <input id="terms" type="checkbox" required />
          <span>Li e aceito os <a href="privacidade.html" target="_blank" rel="noopener">termos e a política de privacidade</a>.</span>
        </label>
        <div id="generalErr" class="error" role="status" aria-live="polite" style="margin-top:.5rem; text-align:center;"></div>
        <div id="termsErr" class="error" role="status" aria-live="polite" style="margin-top:.3rem"></div>

        <button type="submit" class="btn">Registar</button>

        <p class="muted">Já tens conta? <a href="login.html">Entrar</a></p>
      </form>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="main.js" defer></script>
  <script>
    // Mostrar/ocultar password
    document.querySelectorAll('.toggle-pass').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const targetId = btn.getAttribute('data-target');
        const input = document.getElementById(targetId);
        const show = input.type === 'password';
        input.type = show ? 'text' : 'password';
        btn.textContent = show ? 'Ocultar' : 'Mostrar';
        btn.setAttribute('aria-pressed', show ? 'true' : 'false');
        btn.setAttribute('aria-label', show ? 'Ocultar palavra-passe' : 'Mostrar palavra-passe');
        input.focus();
      });
    });

    // Força da password
    const passInput = document.getElementById('password');
    const meterFill = document.getElementById('meterFill');
    function scorePassword(p){
      let s = 0;
      if(!p) return 0;
      if(p.length >= 8) s++;
      if(/[A-Z]/.test(p) && /[a-z]/.test(p)) s++;
      if(/\d/.test(p)) s++;
      if(/[^\w\s]/.test(p)) s++;
      return s;
    }
    passInput.addEventListener('input', ()=>{
      const s = scorePassword(passInput.value);
      meterFill.style.width = (s*25)+'%';
    });

    // Validação
    const form = document.getElementById('registerForm');
    const nomeErr = document.getElementById('nomeErr');
    const emailErr = document.getElementById('emailErr');
    const passErr  = document.getElementById('passErr');
    const confirmErr = document.getElementById('confirmErr');
    const termsErr = document.getElementById('termsErr');
    const generalErr = document.getElementById('generalErr');

    const showErr = (el,msg)=>{ el.textContent=msg; el.setAttribute('aria-live','polite'); el.style.display='block'; }
    const hideErr = (el)=>{ el.textContent=''; el.removeAttribute('aria-live'); el.style.display='none'; }

    function validate(){
      let ok = true;
      if(!form.nome.value.trim()){ showErr(nomeErr,'Indica o teu nome.'); ok=false } else hideErr(nomeErr);
      if(!form.email.checkValidity()){ showErr(emailErr,'Introduz um e-mail válido.'); ok=false } else hideErr(emailErr);
      const p = form.password.value;
      if(p.length < 8){ showErr(passErr,'Mínimo 8 caracteres (usa maiúsculas/minúsculas, números e símbolos).'); ok=false } else hideErr(passErr);
      if(form.confirm.value !== p || !form.confirm.value){ showErr(confirmErr,'As palavras-passe não coincidem.'); ok=false } else hideErr(confirmErr);
      if(!form.terms.checked){ showErr(termsErr,'Tens de aceitar os termos para continuar.'); ok=false } else hideErr(termsErr);
      return ok;
    }

    const supabase = window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON);

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      hideErr(generalErr);
      if(!validate()) return;

      const email = form.email.value;
      const password = form.password.value;
      const submitBtn = form.querySelector('button[type="submit"]');
      submitBtn.disabled = true;
      submitBtn.textContent = 'A registar...';

      const { data, error } = await supabase.auth.signUp({
        email: email,
        password: password,
        options: {
          data: {
            full_name: form.nome.value.trim(),
            address: form.morada.value.trim(),
            postal_code: form.codigo_postal.value.trim(),
            city: form.localidade.value.trim()
          }
        }
      });

      if (error) {
        showErr(generalErr, `Erro: ${error.message}`);
        submitBtn.disabled = false;
        submitBtn.textContent = 'Registar';
      } else {
        // Hide form and show success message
        form.style.display = 'none';
        const subtitle = document.querySelector('.subtitle');
        subtitle.innerHTML = '<h2>Registo quase concluído!</h2><p style="font-size: 1.1rem; line-height: 1.6;">Enviámos um e-mail de confirmação para <strong>' + email + '</strong>. <br>Por favor, clique no link dentro do e-mail para ativar a sua conta.</p><p>(Verifique também a sua pasta de spam)</p>';
        // Remove o título original para não duplicar
        document.querySelector('.title').style.display = 'none';
      }
    });

    ['nome','email','password','confirm', 'terms'].forEach(id=>{
      document.getElementById(id).addEventListener('input', ()=>{
        if(id==='nome') hideErr(nomeErr);
        if(id==='email') hideErr(emailErr);
        if(id==='password') hideErr(passErr);
        if(id==='confirm') hideErr(confirmErr);
      });
    });

    // Ajuste quando o teclado abre (mobile)
    const card = document.querySelector('.auth-card');
    function fixViewportHeight(){
      if(window.visualViewport){
        const h = Math.max(480, window.visualViewport.height - 24);
        card.style.maxHeight = h + 'px';
      }
    }
    if(window.visualViewport){
      fixViewportHeight();
      window.visualViewport.addEventListener('resize', fixViewportHeight);
    }
  </script>
</body>
</html>
